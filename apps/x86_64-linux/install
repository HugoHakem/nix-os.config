#!/usr/bin/env bash

set -exu # -e: Exit on any error. -x: Print each command before executing. -u: Treat unset variables as an error.

BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m'

BRANCH="hh-virtual-machine"
REPO="HugoHakem/nix-os.config"

check_installer() {
  if ! command -v nix &> /dev/null; then
    echo "${RED}Nix is not installed. Please install it first.${NC}"
    exit 1
  fi
}

# you need to change it to the relevant file. 
cleanup() {
  rm -rf nixos-config-$BRANCH.zip nixos-config-$BRANCH
}

# Function to check if a command is available, and use Nix if not
create_shell() {
  echo -e "${YELLOW}$1 not found. Using Nix to provide it...${NC}"
  nix shell --extra-experimental-features 'nix-command flakes' nixpkgs#unzip nixpkgs#curl nixpkgs#wget 
}

exit_shell() {
  exit
}

download_config() {
  echo "${YELLOW}Downloading Nix Configuration...${NC}"
  curl -LJ0 https://github.com/$REPO/archive/$BRANCH.zip -o nixos-config-$BRANCH.zip
  unzip nixos-config-$BRANCH.zip
  mv nixos-config-$BRANCH nixos-config
  cd nixos-config
}

run_apply() {
  ./apps/x86_64-linux/apply
  if [ ! -f /tmp/username.txt ]; then
    echo -e "${RED}Error: /tmp/username.txt does not exist.${NC}"
    exit 1
  fi
  export USERNAME=$(cat /tmp/username.txt)
}

# should we actually reboot ? 
prompt_reboot() {
  read -p "Do you want to reboot now? (y/yes) " choice
  case "$choice" in
  y|Y|yes|YES ) echo -e "${YELLOW}Rebooting...${NC}" && sudo reboot;;
  * ) echo -e "${RED}Reboot skipped.${NC}";;
  esac
}

check_nvidia() {
  if command -v nvidia-smi &> /dev/null; then
    # NVIDIA drivers are already installed, check if it's working
    if nvidia-smi &> /dev/null; then
      echo -e "${GREEN}NVIDIA drivers are already installed and the GPU is working.${NC}"
      return 0  # NVIDIA drivers are working
    else
      echo -e "${YELLOW}NVIDIA drivers are installed, but nvidia-smi is not returning valid information.${NC}"
      return 1  # NVIDIA drivers installed but not working
    fi
  else
    echo -e "${RED}No NVIDIA drivers found on this system.${NC}"
    return 2  # No NVIDIA drivers installed
  fi
}

# Prompt to install NVIDIA drivers if no GPU or not CUDA-enabled GPU
prompt_install_nvidia() {
  read -p "Do you want to install NVIDIA drivers (only if a CUDA-compatible GPU is available)? (y/n) " choice
  case "$choice" in
    y|Y|yes|YES)
      echo -e "${YELLOW}Proceeding to install NVIDIA drivers...${NC}"
      install_nvidia_drivers
      ;;
    *)
      echo -e "${YELLOW}Skipping NVIDIA drivers installation.${NC}"
      ;;
  esac
}

# Function to install the NVIDIA drivers (if not already installed)
install_nvidia_drivers() {
  echo -e "${BLUE}Checking system architecture and OS...${NC}"
  . /etc/os-release
  OS_ID=$ID
  OS_VERSION_ID=$VERSION_ID
  ARCH=$(uname -m)
  case "$ARCH" in
    x86_64)
      ARCH_PATH="x86_64"
      ;;
    aarch64)
      ARCH_PATH="arm64"
      ;;
    *)
      echo -e "${RED}Unsupported architecture: $ARCH${NC}"
      exit 1
      ;;
  esac

  # Assuming we're adding CUDA repo from NVIDIA
  echo -e "${BLUE}Installing CUDA drivers...${NC}"
  
  if [ "$OS_ID" == "ubuntu" ]; then
    URL="https://developer.download.nvidia.com/compute/cuda/repos/${OS_ID}${OS_VERSION_ID}/${ARCH_PATH}/cuda-keyring_1.1-1_all.deb"
    echo -e "${BLUE}Adding NVIDIA package repositories...${NC}"
    # Add the NVIDIA CUDA keyring and repo
    wget $URL
    sudo dpkg -i cuda-keyring_1.1-1_all.deb
    sudo apt-get update
    sudo apt-get -y install cuda
    echo -e "${BLUE}Verifying installation...${NC}"

    rm -f cuda-keyring_1.1-1_all.deb

    if nvidia-smi; then
      echo -e "${GREEN}NVIDIA drivers installed successfully.${NC}"
    else
      echo -e "${RED}Failed to install NVIDIA drivers.${NC}"
      exit 1
    fi

  else
    echo -e "${RED}Unsupported OS version for this script (only Ubuntu is supported). Please start again but skipping cuda installation.${NC}"
    exit 1
  fi
}

# Main script execution
cleanup
check_installer
create_shell
download_config
run_apply
check_nvidia
case $? in
  0)  # NVIDIA drivers are installed and working
    echo -e "${YELLOW}No need to install NVIDIA drivers. Proceeding...${NC}"
    ;;
  1)  # NVIDIA drivers are installed but not working
    prompt_install_nvidia
    ;;
  2)  # No NVIDIA drivers installed
    prompt_install_nvidia
    ;;
  *)
    echo -e "${RED}Unexpected error.${NC}"
    exit 1
    ;;
esac
cleanup
exit_shell
prompt_reboot